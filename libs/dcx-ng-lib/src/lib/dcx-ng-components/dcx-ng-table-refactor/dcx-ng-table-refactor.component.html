<div
  class="table-wrapper"
  [class.scroll]="scroll()"
  [style.max-height]="scroll() ? scrollHeight() : null"
>
  <table [class.grid]="showGrid()" [class.striped]="showStripped()">
    <!-- ==================== HEADER ==================== -->
    <thead>
      <tr>
         @if (showRowIndex()) {
          <th scope="col" class="row-index-header">
            {{ rowIndexLabel() }}
          </th>

        }

        @for (header of displayHeaders(); track header.key; let colIndex = $index) {
          <th
            #headerCell
            scope="col"
            [class.sortable]="header.sortable"
            [class.frozen-left]="frozenMeta()[colIndex].left !== null"
            [class.frozen-right]="frozenMeta()[colIndex].right !== null"
            [class.frozen-separator-left]="frozenMeta()[colIndex].separatorLeft"
            [class.frozen-separator-right]="frozenMeta()[colIndex].separatorRight"
            [style.left.px]="frozenMeta()[colIndex].left"
            [style.right.px]="frozenMeta()[colIndex].right"
            [style.min-width]="header.minWidth || null"
            [style.max-width]="header.maxWidth || null"
            [style.width]="header.width || null"
            [attr.aria-sort]="ariaSort(header)"
            [attr.tabindex]="header.sortable ? 0 : null"
            (click)="onHeaderClick(header)"
            (keydown.enter)="onHeaderClick(header)"
            (keydown.space)="onHeaderClick(header); $event.preventDefault()"
          >
            <div class="th-content">
              <ng-container
                [ngTemplateOutlet]="getHeaderTemplate(header)"
                [ngTemplateOutletContext]="{ $implicit: header }"
              />
            </div>

            @if (header.filterable && header.key) {
              <div class="filter-input-wrapper">
                <input
                  type="text"
                  class="filter-input"
                  [placeholder]="'Filtrar ' + header.name"
                  [value]="getFilterValue(header.key)"
                  (click)="$event.stopPropagation()"
                  (input)="onFilterChange(header.key, $any($event.target).value)"
                />
              </div>
            }
          </th>
        }
        <th class="menu-col" scope="col"></th>
      </tr>
    </thead>

    <!-- ==================== BODY ==================== -->
    <tbody>
      @if (sortedRows().length === 0) {
        <tr>
          <td [attr.colspan]="displayHeaders().length + 1 + (showRowIndex() ? 1 : 0)"
          class="empty-cell">
            <ng-container
              [ngTemplateOutlet]="getEmptyTemplate()"
              [ngTemplateOutletContext]="{ headers: displayHeaders() }"
            />
          </td>
        </tr>
      } @else {
        @for (row of paginatedRows(); track row.id; let rowIndex = $index) {
          <tr class="table-row">

            @if (showRowIndex()) {
              <td class="row-index-cell">
                {{ getRowDisplayIndex(rowIndex) }}
              </td>
            }

            @for (header of displayHeaders(); track header.key; let colIndex = $index) {
              <td
                [class.editable]="header.editable"
                [class.frozen-left]="frozenMeta()[colIndex].left !== null"
                [class.frozen-right]="frozenMeta()[colIndex].right !== null"
                [class.frozen-separator-left]="frozenMeta()[colIndex].separatorLeft"
                [class.frozen-separator-right]="frozenMeta()[colIndex].separatorRight"
                [style.left.px]="frozenMeta()[colIndex].left"
                [style.right.px]="frozenMeta()[colIndex].right"
                [style.min-width]="header.minWidth || null"
                [style.max-width]="header.maxWidth || null"
                [style.width]="header.width || null"
                (dblclick)="onCellDblClick(rowIndex, header.key || '', header)"
              >
                @if (isEditing(rowIndex, header.key || '')) {
                  <input
                    #editInput
                    type="text"
                    class="cell-edit-input"
                    [value]="row[header.key || '']"
                    (blur)="onCellEditComplete(row, header.key || '', editInput.value, rowIndex)"
                    (keydown.enter)="onCellEditComplete(row, header.key || '', editInput.value, rowIndex)"
                    (keydown.escape)="onCellEditCancel()"
                  />
                } @else {
                  <ng-container
                    [ngTemplateOutlet]="getCellTemplate(header)"
                    [ngTemplateOutletContext]="{
                      $implicit: row,
                      row: row,
                      key: header.key,
                      header: header
                    }"
                  />
                }
              </td>
            }
            <td class="menu-col">
              <ng-container
                [ngTemplateOutlet]="getMenuTemplate()"
                [ngTemplateOutletContext]="{ $implicit: row, row: row, index: $index }"
              />
            </td>
          </tr>
        }
      }
    </tbody>
  </table>
</div>

<!-- ==================== PAGINADOR ==================== -->
@if (paginator()) {
  <dcx-ng-table-paginator
    [length]="sortedRows().length"
    [pageIndex]="pageIndex()"
    [pageSize]="pageSize()"
    [pageSizeOptions]="rowsPerPageOptions()"
    (pageChange)="goToPage($event)"
    (rowsPerPageChange)="onRowsPerPageChange($event)"
  />
}

<!-- ==================== DEFAULT TEMPLATES ==================== -->
<ng-template #defaultHeaderTpl let-header>
  <strong>{{ header.name }}</strong>
  @if (header.sortable) {
    <span class="sort-indicator" aria-hidden="true">
      <dcx-ng-icon [name]="getSortIcon(header)" size="s" />
    </span>
  }
</ng-template>

<ng-template #defaultCellTpl let-row let-key="key" let-header="header">
  {{ header.renderFn ? header.renderFn(row, key) : row?.[key] }}
</ng-template>

<ng-template #builtInDateTpl let-row let-key="key" let-header="header">
  <span style="color: #666;">
    {{ row?.[key] | date: (header.dateConfig?.dateFormat || 'dd/MM/yyyy HH:mm') }}
  </span>
</ng-template>

<ng-template #defaultMenuCellTpl>
  <button
    type="button"
    class="btn icon"
    title="MenÃº contextual"
    disabled
    aria-disabled="true"
  >
    <dcx-ng-icon name="more_vert" size="m" />
  </button>
</ng-template>

<ng-template #defaultEmptyTpl>No hay datos</ng-template>
