<div
  class="table-wrapper"
  [class.scroll]="scroll()"
  [style.max-height]="scroll() ? scrollHeight() : null"
  (click)="closeAllMenus()"
  role="region"
  aria-label="Tabla de datos con ordenación y filtrado"
>
  <!-- Región live para anunciar cambios de ordenación/filtrado -->
  <div class="sr-only" aria-live="polite" aria-atomic="true">
    @if (sortLabel() && sort().dir) {
      Ordenado por {{ sortLabel() }} en orden {{ sort().dir === 'asc' ? 'ascendente' : 'descendente' }}
    }
  </div>

  <table [class.grid]="showGrid()" [class.striped]="showStripped()">
    <!-- ==================== HEADER ==================== -->
    <thead>
      <tr>
         @if (showRowIndex()) {
          <th scope="col" class="row-index-header">
            {{ rowIndexLabel() }}
          </th>

        }

        @for (header of displayHeaders(); track header.key; let colIndex = $index) {
          <th
            #headerCell
            scope="col"
            [class.sortable]="header.sortable"
            [class.frozen-left]="frozenMeta()[colIndex].left !== null"
            [class.frozen-right]="frozenMeta()[colIndex].right !== null"
            [class.frozen-separator-left]="frozenMeta()[colIndex].separatorLeft"
            [class.frozen-separator-right]="frozenMeta()[colIndex].separatorRight"
            [style.left.px]="frozenMeta()[colIndex].left"
            [style.right.px]="frozenMeta()[colIndex].right"
            [style.min-width]="header.minWidth || null"
            [style.max-width]="header.maxWidth || null"
            [style.width]="header.width || null"
            [attr.aria-sort]="ariaSort(header)"
            [attr.tabindex]="header.sortable ? 0 : null"
            (click)="onHeaderClick(header)"
            (keydown.enter)="onHeaderClick(header)"
            (keydown.space)="onHeaderClick(header); $event.preventDefault()"
          >
            <div class="th-content">
              <ng-container
                [ngTemplateOutlet]="getHeaderTemplate(header)"
                [ngTemplateOutletContext]="{ $implicit: header }"
              />
            </div>

            @if (header.filterable && header.key) {
              <div class="filter-input-wrapper">
                <input
                  type="text"
                  class="filter-input"
                  [placeholder]="'Filtrar ' + header.name"
                  [value]="getFilterValue(header.key)"
                  (click)="$event.stopPropagation()"
                  (input)="onFilterChange(header.key, $any($event.target).value)"
                />
              </div>
            }
          </th>
        }
      </tr>
    </thead>

    <!-- ==================== BODY ==================== -->
    <tbody>
      @if (sortedRows().length === 0) {
        <tr>
          <td [attr.colspan]="displayHeaders().length + (showRowIndex() ? 1 : 0)"
          class="empty-cell">
            <ng-container
              [ngTemplateOutlet]="getEmptyTemplate()"
              [ngTemplateOutletContext]="{ headers: displayHeaders() }"
            />
          </td>
        </tr>
      } @else {
        @for (row of paginatedRows(); track row.id; let rowIndex = $index) {
          <tr class="table-row">

            @if (showRowIndex()) {
              <td class="row-index-cell">
                {{ getRowDisplayIndex(rowIndex) }}
              </td>
            }

            @for (header of displayHeaders(); track header.key; let colIndex = $index) {
              <td
                [class.editable]="header.editable"
                [class.frozen-left]="frozenMeta()[colIndex].left !== null"
                [class.frozen-right]="frozenMeta()[colIndex].right !== null"
                [class.frozen-separator-left]="frozenMeta()[colIndex].separatorLeft"
                [class.frozen-separator-right]="frozenMeta()[colIndex].separatorRight"
                [style.left.px]="frozenMeta()[colIndex].left"
                [style.right.px]="frozenMeta()[colIndex].right"
                [style.min-width]="header.minWidth || null"
                [style.max-width]="header.maxWidth || null"
                [style.width]="header.width || null"
                (dblclick)="onCellDblClick(rowIndex, header.key || '', header)"
              >
                @if (isEditing(rowIndex, header.key || '')) {
                  <input
                    #editInput
                    type="text"
                    class="cell-edit-input"
                    [value]="row[header.key || '']"
                    (blur)="onCellEditComplete(row, header.key || '', editInput.value, rowIndex)"
                    (keydown.enter)="onCellEditComplete(row, header.key || '', editInput.value, rowIndex)"
                    (keydown.escape)="onCellEditCancel()"
                  />
                } @else {
                  <ng-container
                    [ngTemplateOutlet]="getCellTemplate(header)"
                    [ngTemplateOutletContext]="{
                      $implicit: row,
                      row: row,
                      key: header.key,
                      header: header,
                      rowIndex: rowIndex
                    }"
                  />
                }
              </td>
            }
          </tr>
        }
      }
    </tbody>
  </table>

  <!-- NEW: overlay global para el menú de acciones (tipo appendTo="body") REVISAR NO ME TERMINA DE CONVENCER -->
  @if (actionsOverlay()) {
    <div
      class="actions-overlay-backdrop"
      (click)="closeAllMenus()"
    >
      <div
        class="actions-overlay-dropdown"
        role="menu"
        (click)="$event.stopPropagation()"
        [style.top.px]="actionsOverlay()!.y"
        [style.left.px]="actionsOverlay()!.x"
      >
        @if ($any(actionsOverlay()!.header.cellTypeConfig)?.items?.length) {
          @for (action of $any(actionsOverlay()!.header.cellTypeConfig).items; track action.id) {
            @if (!action.hidden || !action.hidden(actionsOverlay()!.row)) {
              <button
                type="button"
                class="action-menu-item"
                [class.action-danger]="action.variant === 'danger'"
                [disabled]="action.disabled ? action.disabled(actionsOverlay()!.row) : false"
                (click)="onActionClick(action.id, actionsOverlay()!.row, actionsOverlay()!.rowIndex)"
              >
                <dcx-ng-icon [name]="action.icon" size="s" />
                <span>{{ action.label }}</span>
              </button>
            }
          }
        }
      </div>
    </div>
  }
</div>

<!-- ==================== PAGINADOR ==================== -->
@if (paginator()) {
  <dcx-ng-table-paginator
    [length]="sortedRows().length"
    [pageIndex]="pageIndex()"
    [pageSize]="pageSize()"
    [pageSizeOptions]="rowsPerPageOptions()"
    (pageChange)="goToPage($event)"
    (rowsPerPageChange)="onRowsPerPageChange($event)"
  />
}

<!-- ==================== DEFAULT TEMPLATES ==================== -->
<ng-template #defaultHeaderTpl let-header>
  <strong>{{ header.name }}</strong>
  @if (header.sortable) {
    <span class="sort-indicator" aria-hidden="true">
      <dcx-ng-icon [name]="getSortIcon(header)" size="s" />
    </span>
  }
</ng-template>

<ng-template #defaultCellTpl let-row let-key="key" let-header="header">
  {{ header.renderFn ? header.renderFn(row, key) : row?.[key] }}
</ng-template>

<ng-template #builtInDateTpl let-row let-key="key" let-header="header">
  <span style="color: #666;">
    {{ row?.[key] | date: ((header.cellTypeConfig?.dateFormat) || 'dd/MM/yyyy HH:mm') }}
  </span>
</ng-template>

<ng-template #builtInActionsTpl let-row let-header="header" let-rowIndex="rowIndex">
  @if (header.cellTypeConfig) {
    @let config = header.cellTypeConfig;
    @if (config.mode === 'inline') {
      <div class="actions-inline">
        @for (action of config.items; track action.id) {
          @if (!action.hidden || !action.hidden(row)) {
            <button
              type="button"
              class="action-btn"
              [class.action-primary]="action.variant === 'primary'"
              [class.action-danger]="action.variant === 'danger'"
              [class.action-secondary]="action.variant === 'secondary' || !action.variant"
              [title]="action.label"
              [attr.aria-label]="action.label"
              [disabled]="action.disabled ? action.disabled(row) : false"
              (click)="onActionClick(action.id, row, rowIndex)"
            >
              <dcx-ng-icon [name]="action.icon" size="s" />
            </button>
          }
        }
      </div>
    } @else {
      <div class="actions-menu">
        <button
          type="button"
          class="action-menu-btn"
          [title]="'Acciones'"
          [attr.aria-label]="'Menú de acciones'"
          [attr.aria-expanded]="isMenuOpen(rowIndex)"
          [attr.aria-haspopup]="true"
          (click)="openActionsOverlay(rowIndex, header, row, $event)"  
        >
          <dcx-ng-icon [name]="config.menuIcon || 'more_vert'" size="m" />
        </button>

        <!-- DEPRECATED: menú desplegado dentro de la celda (ahora se usa overlay global)
        @if (isMenuOpen(rowIndex)) {
          <div 
            class="actions-dropdown" 
            role="menu"
            (click)="$event.stopPropagation()"
          >
            @for (action of config.items; track action.id) {
              @if (!action.hidden || !action.hidden(row)) {
                <button
                  type="button"
                  class="action-menu-item"
                  [class.action-danger]="action.variant === 'danger'"
                  [disabled]="action.disabled ? action.disabled(row) : false"
                  (click)="onActionClick(action.id, row, rowIndex)"
                >
                  <dcx-ng-icon [name]="action.icon" size="s" />
                  <span>{{ action.label }}</span>
                </button>
              }
            }
          </div>
        }
        -->
      </div>
    }
  }
</ng-template>

<ng-template #defaultEmptyTpl>No hay datos</ng-template>
